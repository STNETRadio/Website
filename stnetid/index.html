<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auth0 - Login & User Profile</title>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.22/auth0-spa-js.production.js"></script>
  <style>
    /* --- Styles --- */
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Form -->
    <div id="loginForm" class="active">
      <!-- Form Elements -->
    </div>

    <!-- User Profile -->
    <div id="profileContainer">
      <!-- Profile Elements -->
    </div>
  </div>

  <script>
    // Auth0 configuration with your provided credentials
    const auth0Config = {
      domain: "auth.stnetradio.com",
      client_id: "xIPl1k0sAZouDiu3qojyscUiEfISLaFL",
      redirect_uri: window.location.origin // แก้ไขการใช้ URI ที่ได้จาก window.location.origin
    };

    let auth0Client = null;

    // Initialize Auth0 client and update the UI accordingly
    async function initAuth0() {
      auth0Client = await createAuth0Client(auth0Config);

      // Handle redirect from Auth0 after login
      if (
        window.location.search.includes("code=") &&
        window.location.search.includes("state=")
      ) {
        await auth0Client.handleRedirectCallback();
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      const isAuthenticated = await auth0Client.isAuthenticated();
      if (isAuthenticated) {
        const user = await auth0Client.getUser();
        showUserProfile(user);
      } else {
        showLoginForm();
      }
    }

    // DOM elements
    const loginForm = document.getElementById("loginForm");
    const profileContainer = document.getElementById("profileContainer");
    const authForm = document.getElementById("authForm");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const emailError = document.getElementById("emailError");
    const passwordError = document.getElementById("passwordError");
    const loginButton = document.getElementById("loginButton");
    const registerButton = document.getElementById("registerButton");
    const googleLogin = document.getElementById("googleLogin");
    const facebookLogin = document.getElementById("facebookLogin");
    const logoutButton = document.getElementById("logoutButton");

    // Profile elements
    const profileImage = document.getElementById("profileImage");
    const profileName = document.getElementById("profileName");
    const profileEmail = document.getElementById("profileEmail");

    // Event: On document load, initialize Auth0
    document.addEventListener("DOMContentLoaded", initAuth0);

    // Handle login form submission using Auth0's Universal Login
    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Reset errors
      emailError.style.display = "none";
      passwordError.style.display = "none";

      const email = emailInput.value;
      const password = passwordInput.value;

      // Basic client-side validation
      let isValid = true;
      if (!isValidEmail(email)) {
        emailError.style.display = "block";
        isValid = false;
      }
      if (password.length < 8) {
        passwordError.style.display = "block";
        isValid = false;
      }
      if (!isValid) return;

      try {
        loginButton.disabled = true;
        loginButton.textContent = "Redirecting...";
        // Trigger the redirect to Auth0 Universal Login.
        await auth0Client.loginWithRedirect({
          redirect_uri: auth0Config.redirect_uri,
          login_hint: email
        });
      } catch (error) {
        console.error("Login failed:", error);
      } finally {
        loginButton.disabled = false;
        loginButton.textContent = "Sign In";
      }
    });

    // Social logins trigger the redirect with the specified connection
    googleLogin.addEventListener("click", async () => {
      try {
        await auth0Client.loginWithRedirect({
          redirect_uri: auth0Config.redirect_uri,
          connection: "google-oauth2"
        });
      } catch (error) {
        console.error("Google login failed:", error);
      }
    });

    facebookLogin.addEventListener("click", async () => {
      try {
        await auth0Client.loginWithRedirect({
          redirect_uri: auth0Config.redirect_uri,
          connection: "facebook"
        });
      } catch (error) {
        console.error("Facebook login failed:", error);
      }
    });

    // Handle logout
    logoutButton.addEventListener("click", async () => {
      try {
        await auth0Client.logout({
          returnTo: auth0Config.redirect_uri
        });
        showLoginForm();
      } catch (error) {
        console.error("Logout failed:", error);
      }
    });

    // Show login form
    function showLoginForm() {
      loginForm.classList.add("active");
      profileContainer.classList.remove("active");
      emailError.style.display = "none";
      passwordError.style.display = "none";
      authForm.reset();
    }

    // Show user profile
    function showUserProfile(user) {
      loginForm.classList.remove("active");
      profileContainer.classList.add("active");
      profileImage.src = user.picture || "/api/placeholder/80/80";
      profileName.textContent = user.name || "User";
      profileEmail.textContent = user.email || "";
    }

    // Helper functions
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

  </script>
</body>
</html>